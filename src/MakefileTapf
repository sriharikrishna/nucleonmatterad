TAPENADE_HOME = /Users/snarayan/soft/tapenade_3.15/
TPN  = ${TAPENADE_HOME}/bin/tapenade

CC = gcc
FC = gfortran

#FFLAGS   = -O0 -g -fdefault-double-8 -fdefault-real-8  -fno-range-check -ffpe-trap=invalid
#FFLAGS   = -O0 -g -fdefault-double-8 -fdefault-real-8 -mcmodel=medium -fno-range-check -ffpe-trap=invalid
#FFLAGS   = -O0 -g -fdefault-double-8 -fdefault-real-8 -fno-range-check  -ffpe-trap=invalid,zero,overflow -fbacktrace
#FFLAGS   = -O3  -fdefault-double-8 -fdefault-real-8 -fno-range-check  -fbacktrace
#FFLAGS   = -O3  -fdefault-double-8 -fdefault-real-8 -fno-range-check  
FFLAGS   = -O30 -g  -fdefault-double-8 -fdefault-real-8 -fno-range-check  
F90FLAGS = $(FFLAGS)
#CFLAGS   = -g
#CPPFLAGS = -g

#TARGETS =  nmad nmadv 
TARGETS =  nmadv 
#numCore_d.pre.f nmadv numCore_dv.pre.f
ifdef BFGS
CPPFLAGS+=-DBFGS
endif
all: ${TARGETS}

SRC=\
nmmainad.f\
nmmain.f\
nmhnc.f\
nmtbi.f\
nmchain.f\
nmfts.f\
nmsub.f

SRCSUB= sub/eft_pot_r.pre.f\
sub/pot.pre.f\
sub/numrec.pre.f\
sub/dgamma.pre.f

OBJSUB= sub/dtime.o sub/headtime.pre.o sub/linpack.pre.o sub/minimi.pre.o sub/numrec.pre.o \
   sub/pot.pre.o sub/eft_pot_r.pre.o sub/dgamma.pre.o isnan_d.o

OBJLBFGS=lbfgs_um/sdrive.o lbfgs_um/lbfgs.o

nmad: numCore_d.pre.o nm.pre.o nmsub.pre.o $(OBJSUB) $(OBJLBFGS)
	${FC} ${FFLAGS} -o $@ $^

nmadv: numCore_dv.pre.o nm.pre.o nmsub.pre.o $(OBJSUB) $(OBJLBFGS)
	${FC} ${FFLAGS} -o $@ $^

numCore.f: $(SRC) $(SRCSUB)
	cat $^ > $@ 


#numCore_d.pre.f: numCore.pre.f
#	${TPN} -forward -head nmmainad  $< 
#	mv numCore.pre_d.f $@

numCore_dv.pre.f: numCore.pre.f
	${TPN} -forward -vector -head nmmainad  $< 
	mv numCore.pre_dv.f $@

CPPFLAGS= $(DIFF) -DALLOW_TAPENADE -DALLOW_DATA
ifdef BFGS
CPPFLAGS+=-DBFGS
endif
ifdef ALL
CPPFLAGS+=-DDO_ALL
endif
CPPCMD = cat $< |  cpp  $(CPPFLAGS)  -I../ -I./ -traditional-cpp -P 

%.pre.c: %.c
	$(CPPCMD) > $@

%.pre.f: %.f
	$(CPPCMD) > $@

%.o : %.F
	${FC} ${FFLAGS} -cpp  -o $@ -c $<

%.o : %.f90
	${FC} ${F90FLAGS} -cpp -o $@ -c $< 

%.o : %.f
	${FC} ${F90FLAGS} -cpp -o $@ -c $< 

%.o : %.c
	${CC} -cpp -o $@ -c $< 

#
# transformation rules
#


clean:	
	/bin/rm -f *.pre.f *.o *.cpp *.msg *.mod numCore.* nclude/*.o nclude/*.mod params_d.f nmad nmadv
	/bin/rm -f sub/*.pre.f sub/*.o sub/*.cpp sub/*.msg sub/*.mod numCore.* nclude/*.o nclude/*.mod
	/bin/rm -f lbfgs_um/*.o

realclean: clean	
	/bin/rm -f $(TARGETS)

